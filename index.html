<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Justin Cheong - Portfolio</title>
    <style>
        /* --- FONTS --- */
        /* NOTE: If you moved fonts to a 'fonts' folder, change url to 'fonts/Phenomena-ExtraBold.otf' */
        @font-face {
            font-family: 'Phenomena';
            src: url('Phenomena-ExtraBold.otf'); 
        }
        @font-face {
            font-family: 'MyCustomFont';
            src: url('font.ttf'); 
        }

        body { 
            margin: 0; 
            background-color: #cccccc; 
            overflow: hidden; 
            font-family: 'Phenomena', 'Segoe UI', sans-serif; 
        }
        
        /* --- HEADER & NAV --- */
        #header-name {
            position: absolute; top: 30px; left: 30px;
            color: #000000; font-size: 36px;
            font-weight: 800; letter-spacing: 2px; text-transform: uppercase;
            pointer-events: none; z-index: 100;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.4); 
        }

        #nav-menu {
            position: absolute; top: 30px; right: 30px;
            display: flex; gap: 15px;
            z-index: 100;
        }

        .nav-btn {
            background: #000000; color: #ffffff;
            padding: 10px 20px; font-family: 'Phenomena', sans-serif;
            font-weight: bold; font-size: 18px;
            cursor: pointer; border-radius: 6px;
            transition: all 0.2s; text-transform: uppercase;
            border: 2px solid transparent; 
        }
        
        .nav-btn:hover { transform: translateY(-2px); background: #222; }

        /* BUTTON GLOWS */
        #btn-battery { box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); border-color: #00d2ff; }
        #btn-wire { box-shadow: 0 0 15px rgba(0, 255, 136, 0.4); border-color: #00ff88; }
        #btn-bulb { box-shadow: 0 0 15px rgba(255, 170, 0, 0.4); border-color: #ffaa00; }
        #btn-switch { box-shadow: 0 0 15px rgba(255, 102, 0, 0.4); border-color: #ff6600; }

        /* --- CONTROLS PANEL --- */
        #controls-key {
            display: none; 
            position: absolute; top: 90px; left: 30px;
            width: 300px;
            color: #fff; background: rgba(0, 0, 0, 0.85); 
            border: 1px solid #444; padding: 25px;
            border-radius: 12px; font-family: 'Segoe UI', sans-serif;
            font-size: 14px; z-index: 100; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            pointer-events: auto; 
        }
        
        .controls-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #666; padding-bottom: 10px; margin-bottom: 15px;
        }

        .key-title { font-family: 'Phenomena', sans-serif; font-size: 24px; color: #00d2ff; }
        
        .close-controls {
            cursor: pointer; font-weight: bold; font-size: 20px; color: #aaa; transition: color 0.2s;
        }
        .close-controls:hover { color: #fff; }

        .key-item { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .key-action { font-weight: 600; color: #ddd; }
        .key-bind { background: #333; color: #00d2ff; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; font-family: monospace; }

        /* --- STATUS TAB (IN PROGRESS) --- */
        #status-tab {
            position: absolute; bottom: 30px; left: 30px;
            background: #000; border: 2px solid #ffaa00; 
            color: #ffaa00; padding: 12px 20px; border-radius: 6px;
            font-family: 'Phenomena', sans-serif; font-size: 20px; font-weight: bold;
            z-index: 100; display: flex; align-items: center; gap: 12px;
            pointer-events: none; 
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.2);
            letter-spacing: 1px;
        }
        
        .status-led {
            width: 12px; height: 12px; background: #ffaa00; border-radius: 50%;
            box-shadow: 0 0 10px #ffaa00;
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }

        /* --- BOTTOM CONTROLS --- */
        #bottom-controls {
            position: absolute; bottom: 30px; right: 30px;
            display: flex; gap: 10px; z-index: 100;
        }

        #reset-btn {
            background: #000; color: #00d2ff; 
            border: 2px solid #00d2ff; padding: 12px 24px; 
            font-size: 18px; font-weight: bold;
            cursor: pointer; border-radius: 6px;
            transition: all 0.2s; font-family: 'Phenomena', sans-serif;
            letter-spacing: 1px;
        }
        #reset-btn:hover { background: #00d2ff; color: #000; box-shadow: 0 0 20px #00d2ff; }

        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #000; font-family: 'Phenomena', sans-serif; font-size: 48px; 
            pointer-events: none; text-shadow: 0px 0px 20px rgba(255, 255, 255, 0.8);
        }

        /* --- MINI POPUP --- */
        #mini-popup {
            display: none;
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
            width: 420px; padding: 35px; 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 4px; 
            border-left: 8px solid #00d2ff; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            backdrop-filter: blur(15px); text-align: left; z-index: 10;
            transition: all 0.3s ease;
        }

        #mini-title { margin: 0 0 15px 0; color: #000; font-family: 'Phenomena', sans-serif; font-size: 36px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        #mini-desc { font-size: 18px; line-height: 1.6; margin-bottom: 25px; color: #333; font-family: 'Segoe UI', sans-serif; font-weight: 500; }

        #read-more-btn {
            display: block; width: 100%; padding: 14px 0;
            background: transparent; color: #000; 
            border: 3px solid #000; border-radius: 6px; 
            font-weight: 800; font-size: 18px;
            cursor: pointer; font-family: 'Phenomena', sans-serif;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s ease;
        }
        #read-more-btn:hover { background: #000; color: #fff; transform: scale(1.02); }

        .close-mini {
            position: absolute; top: 15px; right: 20px;
            font-family: 'Phenomena', sans-serif; font-weight: bold; font-size: 28px;
            cursor: pointer; color: #bbb; transition: color 0.2s;
        }
        .close-mini:hover { color: #000; }

        /* --- FULL MODAL --- */
        #modal-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 1000; justify-content: center; align-items: center;
        }

        #modal-card { display: flex; width: 100%; height: 100%; background: #fff; position: relative; }
        #modal-3d { flex: 10; background: #e0e0e0; position: relative; border-right: 5px solid #000; }
        #modal-info { flex: 11; padding: 80px; background: #f4f4f4; color: #222; overflow-y: auto; display: flex; flex-direction: column; justify-content: center; }

        #modal-project-img {
            width: 100%; max-height: 350px; object-fit: cover;
            border-radius: 12px; margin-bottom: 30px; display: none; 
            border: 4px solid #000; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        h2 { 
            margin-top: 0; color: #000; font-size: 64px; 
            font-family: 'Phenomena', sans-serif; text-transform: uppercase; 
            margin-bottom: 30px; border-bottom: 6px solid #00d2ff; 
            padding-bottom: 15px; line-height: 1;
        }
        p { color: #444; line-height: 1.8; font-size: 20px; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; }
        
        #close-btn {
            position: absolute; top: 30px; right: 40px;
            background: none; border: none; color: #000; 
            cursor: pointer; font-size: 60px; line-height: 1; z-index: 200;
            font-family: 'Phenomena', sans-serif;
        }
        #close-btn:hover { color: #00d2ff; }

        /* TUTORIAL OVERLAY */
        .overlay-screen {
            display: flex; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px);
            z-index: 2000; justify-content: center; align-items: center;
            color: #fff; flex-direction: column; text-align: center;
        }

        .tutorial-content { 
            max-width: 700px; padding: 50px; border: 2px solid #00d2ff; border-radius: 20px; 
            background: rgba(0,0,0,0.6); box-shadow: 0 0 60px rgba(0, 210, 255, 0.15); 
        }
        .tutorial-title { font-size: 64px; font-family: 'Phenomena', sans-serif; margin-bottom: 20px; color: #fff; text-shadow: 0 0 20px #00d2ff; }
        .tutorial-text { font-size: 22px; line-height: 1.6; margin-bottom: 40px; color: #ddd; font-family: 'Segoe UI', sans-serif; }
        
        .step-list { text-align: left; display: inline-block; margin: 0 auto 50px auto; }
        .step-item { margin-bottom: 20px; font-size: 22px; display: flex; align-items: center; }
        .step-num { 
            display: inline-block; width: 40px; height: 40px; border: 3px solid #00d2ff; border-radius: 50%; 
            text-align: center; line-height: 35px; margin-right: 20px; 
            font-weight: bold; flex-shrink: 0; color: #00d2ff; font-family: 'Phenomena', sans-serif; font-size: 24px;
        }
        
        .action-btn {
            background: #fff; color: #000; border: none; padding: 15px 50px; font-size: 28px; font-weight: bold;
            cursor: pointer; border-radius: 8px; box-shadow: 0 0 30px rgba(0, 210, 255, 0.4);
            font-family: 'Phenomena', sans-serif; text-transform: uppercase; transition: all 0.2s;
        }
        .action-btn:hover { transform: scale(1.05); background: #00d2ff; color: #fff; }
        .tutorial-hint { margin-top: 30px; color: #888; font-size: 16px; }

        .collision-flash { animation: flashRed 0.2s ease-out; }
        @keyframes flashRed { 0% { box-shadow: inset 0 0 100px red; } 100% { box-shadow: none; } }
    </style>

    <script>
        // NOTE: If you moved audio to an 'audio' folder, update these paths!
        const audio = new Audio("No_SFX-2023-05-02_-_Galaxys_Endless_Expanse_-_www.FesliyanStudios.com.mp3");
        audio.loop = true; audio.volume = 0.15; 

        const clickSound = new Audio("immersivecontrol-button-click-sound-463065.mp3");
        clickSound.volume = 1.0; 

        const impactSound = new Audio("thud-impact-sound-sfx-379990.mp3");

        function toggleOverlay(id) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'flex' : 'none';
            }
        }

        function playClickSound() {
            clickSound.currentTime = 0; clickSound.play().catch(e => {});
        }

        function startAudio() {
            audio.play().catch(e => {});
            document.removeEventListener('click', startAudio);
        }

        document.addEventListener('click', (event) => {
            if (event.target.closest('button') || event.target.classList.contains('nav-btn') || 
                event.target.classList.contains('action-btn') || event.target.classList.contains('close-controls') || 
                event.target.classList.contains('close-mini')) {
                playClickSound();
            }
            startAudio(); 
        });
    </script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body id="mainBody">

    <div id="tutorial-overlay" class="overlay-screen">
        <div class="tutorial-content">
            <div class="tutorial-title">Welcome to My Circuit Portfolio!</div>
            <div class="tutorial-text">
                I'm Justin Cheong, and this is my interactive circuit board.
                Here's a quick guide to get you started:
            </div>
            <div class="step-list">
                <div class="step-item"><div class="step-num">1</div> <div>Explore the circuit by dragging (Left Click) and panning (Right Click).</div></div>
                <div class="step-item"><div class="step-num">2</div> <div>Click on any component (or use the top navigation) to learn more about it.</div></div>
                <div class="step-item"><div class="step-num">3</div> <div>Press <b>'C'</b> at any time to reset the camera to this view.</div></div>
                <div class="step-item"><div class="step-num">4</div> <div>If you're curious, try pressing <b>'R'</b> to toggle the secret rocket!</div></div>
            </div>
            <button class="action-btn" onclick="toggleOverlay('tutorial-overlay')">Begin Exploration</button>
            <div class="tutorial-hint">You can press 'T' at any time to see this tutorial again.</div>
        </div>
    </div>

    <div id="header-name">JUSTIN CHEONG</div>
    
    <div id="nav-menu">
        <button id="btn-battery" class="nav-btn" onclick="triggerNav('battery')">About Me</button>
        <button id="btn-wire" class="nav-btn" onclick="triggerNav('wire')">Experience</button>
        <button id="btn-bulb" class="nav-btn" onclick="triggerNav('bulb')">Projects</button>
        <button id="btn-switch" class="nav-btn" onclick="triggerNav('switch')">Achievements</button>
    </div>

    <div id="controls-key">
        <div class="controls-header">
            <div class="key-title">Controls</div>
            <div class="close-controls" onclick="document.getElementById('controls-key').style.display='none'">X</div>
        </div>
        <div class="key-item"><span class="key-action">Drag:</span> <span class="key-bind">Left-Click</span></div>
        <div class="key-item"><span class="key-action">Pan:</span> <span class="key-bind">Right-Click</span></div>
        <div class="key-item"><span class="key-action">Zoom:</span> <span class="key-bind">Scroll</span></div>
        <div class="key-item"><span class="key-action">Reset View:</span> <span class="key-bind">'C'</span></div>
        <div class="key-item"><span class="key-action">Toggle Rocket:</span> <span class="key-bind">'R'</span></div>
        <div class="key-item"><span class="key-action">Tutorial:</span> <span class="key-bind">'T'</span></div>
        <div class="key-item"><span class="key-action">Toggle Help:</span> <span class="key-bind">'H'</span></div>
        <hr style="border: 0; border-top: 1px solid #666; margin: 15px 0;">
        <div class="key-item"><span class="key-action">Rocket Move:</span> <span class="key-bind">WASD</span></div>
        <div class="key-item"><span class="key-action">Rocket Lift:</span> <span class="key-bind">Q / E</span></div>
    </div>

    <div id="status-tab">
        <div class="status-led"></div>
        <span>WORK IN PROGRESS</span>
    </div>

    <div id="bottom-controls">
        <button id="reset-btn" onclick="resetCameraView()">RESET CAMERA [C]</button>
    </div>

    <div id="loader">Loading...</div>

    <div id="mini-popup">
        <div class="close-mini" onclick="document.getElementById('mini-popup').style.display='none'">X</div>
        <h3 id="mini-title">Title</h3>
        <div id="mini-desc">Short description...</div>
        <button id="read-more-btn">READ MORE</button>
    </div>

    <div id="modal-overlay">
        <div id="modal-card">
            <button id="close-btn" onclick="document.getElementById('modal-overlay').style.display='none'">×</button>
            <div id="modal-3d"></div>
            <div id="modal-info">
                <img id="modal-project-img" src="" alt="Project Image">
                <h2 id="popup-title">Title</h2>
                <p id="popup-content">Content</p>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- DATA CONTENT ---
        const contentAbout = { 
            title: "About Me", 
            mini: "Powering the System.", 
            color: "#00d2ff", 
            text: "Hello! I'm Justin Cheong, an Electrical Engineering student at Boston University (GPA: 3.89/4.00, Expected May 2027).\n\nMy expertise lies in bridging hardware and software, with coursework in Semiconductor Devices, Nanotechnology, Control Systems, and Logic Design.\n\nTechnical Skills:\n• Programming: C++, Verilog, MATLAB, Python, Java, Android Studio.\n• Environments: Linux, Git, Vivado, Arduino.\n• Instrumentation: Oscilloscope, Signal Generator, BERT." 
        };
        const contentExperience = { 
            title: "Experience & Education", 
            mini: "Connecting the dots.",    
            color: "#00ff88", 
            text: "EDUCATION\nBoston University College of Engineering\n• B.S. in Electrical Engineering\n• Dean's List Recipient (4 Semesters)\n\nEXPERIENCE\nPowdher Construction Management (May 2025 – Aug 2025)\n• Assisted in reviewing electrical blueprints for residential and commercial projects (lighting, power, low-voltage).\n• Conducted on-site walkthroughs to verify field conditions against engineering plans." 
        };
        const contentProjects = { 
            title: "Projects", 
            mini: "Bright Ideas.",          
            color: "#ffaa00", 
            text: "1. Smart Glasses HUD (Jan 2025–Present)\n• Designed a wearable optical system using beam-splitters and micro-OLEDs to overlay digital notifications.\n\n2. Point-to-Point Communication (Sept 2025–Dec 2025)\n• Built a low-power optical link (<5mW laser) with stepper-motor steering for reliable data transmission.\n\n3. Coin-Collecting Robot (March 2025)\n• Engineered a servo-controlled robotic arm with magnet mechanisms for the HackHardware competition.\n\n4. Whack-A-Mole on FPGA (April 2025)\n• Implemented game logic in Verilog using onboard LEDs and 7-segment displays.\n\n5. Acoustic Heart Rate Monitor (Oct 2024)\n• Built an op-amp circuit to amplify heart sounds for oscilloscope visualization." 
        };
        const contentAchievements = { 
            title: "Achievements",  
            mini: "Making the switch.",    
            color: "#ff6600", 
            text: "• Dean's List Recipient: Spring 2024, Fall 2024, Spring 2025, Fall 2025.\n• HackHardware x RASTIC Competitor: Designed and built a competitive autonomous robot.\n• High Academic Standing: Maintained a 3.89 GPA while managing intensive engineering coursework." 
        };

        const myPortfolio = {
            "battery":      { ...contentAbout, target: "battery", popupScale: 7.8, viewDist: 2.5 }, 
            "wire":         { ...contentExperience, target: "wire", popupScale: 4.0, viewDist: 2.0 },
            "bulb":         { ...contentProjects, target: "bulb", popupScale: 6.0, viewDist: 2.0 },
            "switch":       { ...contentAchievements, target: "switch", popupScale: 7.8, viewDist: 2.5 } 
        };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xcccccc); 
        const camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 0.01, 5000 );
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.outputColorSpace = THREE.SRGBColorSpace; 
        document.body.appendChild( renderer.domElement );

        // --- POPUP SCENE ---
        const popupScene = new THREE.Scene();
        popupScene.background = new THREE.Color(0xe0e0e0); 
        const popupCamera = new THREE.PerspectiveCamera( 45, 1, 0.1, 100 );
        popupCamera.position.set(2, 2, 4); 
        const pAmbient = new THREE.AmbientLight(0xffffff, 0.8); popupScene.add(pAmbient);
        const pCamLight = new THREE.DirectionalLight(0xffffff, 1.5); pCamLight.position.set(2, 5, 5); popupScene.add(pCamLight);
        const popupRenderer = new THREE.WebGLRenderer({ antialias: true });
        document.getElementById('modal-3d').appendChild(popupRenderer.domElement);
        const popupControls = new OrbitControls(popupCamera, popupRenderer.domElement);
        popupControls.enableDamping = true; popupControls.autoRotate = true; 

        const loader = new GLTFLoader();
        scene.add( new THREE.AmbientLight( 0xffffff, 0.7 ) );
        const camLight = new THREE.DirectionalLight(0xffffff, 1.5); camLight.position.set(0, 0, 1); camera.add(camLight); scene.add(camera);
        const dirLight = new THREE.DirectionalLight( 0xffffff, 2.0 ); dirLight.position.set( 5, 10, 7.5 ); scene.add( dirLight );

        const controls = new OrbitControls( camera, renderer.domElement );
        controls.enableDamping = true; controls.enablePan = true; controls.enableZoom = true;
        
        // --- ANIMATED TEXTURE GENERATOR ---
        function createFlowTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000000'; ctx.fillRect(0,0,64,64);
            ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, 64, 32); 
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(4, 1); return tex;
        }
        
        let wireTexture = null;
        let rocketContainer = null, rocketModel = null;
        const velocity = new THREE.Vector3(0, 0, 0);
        const acceleration = 0.01, friction = 0.93, maxSpeed = 0.15;      
        let collisionActive = false;

        const rocketHitbox = new THREE.Box3();
        const obstacleSphere = new THREE.Sphere();
        const hitboxVisualSize = new THREE.Vector3(0.5, 0.5, 1.8);
        const hitboxOffset = new THREE.Vector3(0, -4.95, -1.6);
        const manualObstacles = [
            { name: "Battery", pos: new THREE.Vector3(-1.73, -0.32, -2.67), radius: 0.6 },
            { name: "Bulb Glass", pos: new THREE.Vector3(1.21, 0.97, -2.74), radius: 0.6 },
            { name: "Bulb Base", pos: new THREE.Vector3(1.25, 0.07, -2.76), radius: 0.3 },
            { name: "Switch", pos: new THREE.Vector3(0.07, -0.25, -0.50), radius: 0.6 }
        ];

        let explosion = null; const explosionMaxSize = 2.5;
        const keyState = {}; 
        window.addEventListener('keydown', (e) => { 
            keyState[e.code] = true; 
            if(e.code === 'KeyR') toggleRocket(); 
            if(e.code === 'KeyC') resetCameraView();
            if(e.code === 'KeyT') toggleOverlay('tutorial-overlay'); 
            if(e.code === 'KeyH') toggleOverlay('controls-key'); 
            if(e.code === 'Escape') document.getElementById('modal-overlay').style.display = 'none';
        });
        window.addEventListener('keyup', (e) => { keyState[e.code] = false; });

        function toggleRocket() {
            if (rocketContainer) { scene.remove(rocketContainer); rocketContainer = null; velocity.set(0,0,0); } 
            else { spawnRocket(); }
        }

        function createExplosion(pos) {
            const geo = new THREE.SphereGeometry(1, 32, 32);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffff00, transparent: true, opacity: 1.0 });
            explosion = new THREE.Mesh(geo, mat);
            explosion.position.copy(pos); explosion.scale.set(0.1, 0.1, 0.1);
            scene.add(explosion);
        }

        function spawnRocket() {
            // Updated Path for rocket.glb
            loader.load( './models/rocket.glb', function ( gltf ) {
                rocketModel = gltf.scene; rocketModel.updateMatrixWorld(true);
                const box = new THREE.Box3().setFromObject(rocketModel);
                const center = box.getCenter(new THREE.Vector3()); const size = box.getSize(new THREE.Vector3());
                rocketModel.position.x -= center.x; rocketModel.position.y -= center.y; rocketModel.position.z -= center.z;
                rocketModel.traverse((child) => { if (child.isMesh) { child.material = new THREE.MeshStandardMaterial({ color: child.material.color, map: child.material.map || null, metalness: 0.1, roughness: 0.6, side: THREE.DoubleSide }); } });
                rocketContainer = new THREE.Group(); rocketContainer.add(rocketModel);
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim > 0) { const scaleFactor = 2.0 / maxDim; rocketModel.scale.set(scaleFactor, scaleFactor, scaleFactor); }
                rocketModel.rotation.x = -Math.PI / 2; rocketContainer.position.set(1, 6.0, 1); 
                scene.add(rocketContainer);
            });
        }

        let loadedModel, introActive = true, zoomActive = false; 
        let targetPosition = new THREE.Vector3(), targetLookAt = new THREE.Vector3();
        let currentSelection = null; let currentObject = null;   

        window.resetCameraView = function() {
            if(!loadedModel) return;
            introActive = true; zoomActive = false; controls.autoRotate = true; 
            controls.target.set(0, 0.5, 0);
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('mini-popup').style.display = 'none';
            const fov = camera.fov * ( Math.PI / 180 );
            let cameraZ = Math.abs( 5.0 / 2 * Math.tan( fov * 2 ) ); 
            targetPosition.set( cameraZ * 0.5, (cameraZ * 0.5) + 0.5, cameraZ * 2.0 );
            camera.position.copy(targetPosition).multiplyScalar(4); 
            controls.update();
        };
        
        renderer.domElement.addEventListener('pointerdown', () => {
            introActive = false; zoomActive = false; controls.autoRotate = false;
        });

        // --- LOAD MODEL (./models/model.glb) + ANIMATED TEXTURE ---
        loader.load( './models/model.glb', function ( gltf ) {
            loadedModel = gltf.scene; scene.add( loadedModel );
            document.getElementById('loader').style.display = 'none';
            
            wireTexture = createFlowTexture();

            loadedModel.traverse((child) => {
                if (child.isMesh) {
                    const n = child.name.toLowerCase();
                    if (n.includes('wire') && !n.includes('word') && !n.includes('text')) {
                        child.material = new THREE.MeshStandardMaterial({
                            color: 0x333333,       
                            emissive: 0x00ff88,    
                            emissiveMap: wireTexture,
                            emissiveIntensity: 2.0
                        });
                    }
                }
            });

            const box = new THREE.Box3().setFromObject( loadedModel );
            const center = box.getCenter( new THREE.Vector3() ); const size = box.getSize( new THREE.Vector3() );
            loadedModel.position.x += (loadedModel.position.x - center.x) - 1.1;
            loadedModel.position.y += (loadedModel.position.y - center.y) - 4.5; 
            loadedModel.position.z += (loadedModel.position.z - center.z);
            loadedModel.scale.setScalar(5.0 / Math.max( size.x, size.y, size.z ));
            resetCameraView();
        });

        function handleObjectSelection(targetName, objectToFocus) {
            let match = null; const lowerName = targetName.toLowerCase();
            for (const key in myPortfolio) { if (lowerName.includes(key.toLowerCase())) { match = myPortfolio[key]; break; } }
            if (!match) return; 
            currentSelection = match;
            let finalObject = null;
            if (objectToFocus) {
                const n = objectToFocus.name.toLowerCase();
                if (!n.includes('word') && !n.includes('text') && !n.includes('font')) { finalObject = objectToFocus; }
            }
            if (!finalObject && loadedModel) {
                loadedModel.traverse((child) => {
                    if (child.name) {
                        const n = child.name.toLowerCase();
                        if (n.includes(match.target) && !n.includes('word') && !n.includes('text') && !n.includes('font')) { finalObject = child; }
                    }
                });
            }
            if (!finalObject) return;
            currentObject = finalObject; 
            const box = new THREE.Box3().setFromObject(finalObject);
            const center = box.getCenter(new THREE.Vector3()); const size = box.getSize(new THREE.Vector3());
            targetLookAt.copy(center); 
            const dist = Math.max(size.x, size.y, size.z) * (match.viewDist || 2.0); 
            targetPosition.copy(center).add(new THREE.Vector3(0, 1, 1).normalize().multiplyScalar(dist));
            introActive = false; zoomActive = true; controls.autoRotate = false;
            
            const miniPopup = document.getElementById('mini-popup');
            document.getElementById('mini-title').innerText = match.title;
            document.getElementById('mini-desc').innerText = match.mini;
            if (match.color) {
                miniPopup.style.borderLeftColor = match.color;
                miniPopup.style.boxShadow = `0 20px 50px ${match.color}50`;
            }
            miniPopup.style.display = 'block';
        }

        window.triggerNav = (key) => { handleObjectSelection(key, null); }

        document.getElementById('read-more-btn').addEventListener('click', function() {
            if(!currentSelection) return;
            document.getElementById('mini-popup').style.display = 'none';
            const modal = document.getElementById('modal-overlay');
            modal.style.display = 'flex'; 
            document.getElementById('popup-title').innerText = currentSelection.title;
            document.getElementById('popup-content').innerText = currentSelection.text;
            
            const imgEl = document.getElementById('modal-project-img');
            if (currentSelection.img) { imgEl.src = currentSelection.img; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; imgEl.src = ""; }

            if(currentObject) {
                while(popupScene.children.length > 2) { popupScene.remove(popupScene.children[2]); }
                const clone = currentObject.clone();
                clone.position.set(0, 0, 0); clone.rotation.set(0, 0, 0);
                const scaleFactor = currentSelection.popupScale || 1.0;
                clone.scale.multiplyScalar(scaleFactor);
                const box = new THREE.Box3().setFromObject(clone);
                const center = box.getCenter(new THREE.Vector3());
                clone.position.sub(center); 
                popupScene.add(clone);
                popupControls.reset(); popupControls.target.set(0,0,0);
            }
            setTimeout(() => {
                const container = document.getElementById('modal-3d');
                popupRenderer.setSize(container.clientWidth, container.clientHeight);
                popupCamera.aspect = container.clientWidth / container.clientHeight;
                popupCamera.updateProjectionMatrix();
            }, 50);
        });

        window.addEventListener( 'click', (event) => {
            if (event.target.closest('#modal-card') || event.target.closest('#mini-popup') || event.target.closest('.action-btn') || event.target.closest('#controls-key') || event.target.closest('#nav-menu') || event.target.closest('button')) return;
            document.getElementById('mini-popup').style.display = 'none';
            zoomActive = false;
            const mouse = new THREE.Vector2(( event.clientX / window.innerWidth ) * 2 - 1, -( event.clientY / window.innerHeight ) * 2 + 1);
            const raycaster = new THREE.Raycaster(); raycaster.setFromCamera( mouse, camera );
            if(loadedModel) {
                const hits = raycaster.intersectObjects( loadedModel.children, true );
                if ( hits.length > 0 ) {
                    let o = hits[0].object;
                    while(o.parent && (o.name === "" || o.name.includes("Object_"))) o = o.parent;
                    handleObjectSelection(o.name, o);
                }
            }
        });

        function animate() {
            requestAnimationFrame( animate );
            if (wireTexture) { wireTexture.offset.x -= 0.01; } // ANIMATE WIRES

            if (explosion) {
                explosion.scale.addScalar(0.15);
                explosion.material.opacity -= 0.04;
                if (explosion.scale.x > explosionMaxSize || explosion.material.opacity <= 0) {
                    scene.remove(explosion);
                    explosion = null;
                }
            }
            if (rocketContainer) {
                if (keyState['KeyW']) velocity.z -= acceleration;
                if (keyState['KeyS']) velocity.z += acceleration;
                if (keyState['KeyA']) velocity.x -= acceleration;
                if (keyState['KeyD']) velocity.x += acceleration;
                if (keyState['KeyQ']) velocity.y += acceleration;
                if (keyState['KeyE']) velocity.y -= acceleration;
                velocity.multiplyScalar(friction); velocity.clampLength(0, maxSpeed); 
                if (Math.abs(velocity.x) > 0.001 || Math.abs(velocity.z) > 0.001) {
                    const angle = Math.atan2(velocity.x, velocity.z) + Math.PI;
                    let delta = angle - rocketContainer.rotation.y;
                    while (delta > Math.PI) delta -= Math.PI * 2;
                    while (delta < -Math.PI) delta += Math.PI * 2;
                    rocketContainer.rotation.y += delta * 0.2; 
                }
                const currentHitboxPos = hitboxOffset.clone().applyQuaternion(rocketContainer.quaternion).add(rocketContainer.position);
                rocketHitbox.setFromCenterAndSize(currentHitboxPos, hitboxVisualSize);
                manualObstacles.forEach(obs => {
                    obstacleSphere.set(obs.pos, obs.radius);
                    if (rocketHitbox.intersectsSphere(obstacleSphere) && !collisionActive) {
                        impactSound.currentTime = 0; impactSound.play().catch(e => {});
                        document.body.classList.add('collision-flash');
                        setTimeout(() => document.body.classList.remove('collision-flash'), 200);
                        collisionActive = true; createExplosion(currentHitboxPos);
                        setTimeout(() => { toggleRocket(); collisionActive = false; }, 50); 
                    }
                });
                if (rocketContainer) {
                    rocketContainer.position.add(velocity);
                    if(rocketModel) {
                        let pitch = -Math.PI / 2; 
                        if (keyState['KeyQ']) pitch += Math.PI / 4; if (keyState['KeyE']) pitch -= Math.PI / 4; 
                        rocketModel.rotation.x += (pitch - rocketModel.rotation.x) * 0.1;
                    }
                }
            }
            if (introActive && targetPosition.length() > 0) {
                camera.position.lerp(targetPosition, 0.02);
                if (camera.position.distanceTo(targetPosition) < 0.1) introActive = false;
            }
            if (zoomActive) {
                camera.position.lerp(targetPosition, 0.05); controls.target.lerp(targetLookAt, 0.05);
                if (camera.position.distanceTo(targetPosition) < 0.05) zoomActive = false;
            }
            if (document.getElementById('modal-overlay').style.display === 'flex') {
                popupControls.update(); popupRenderer.render(popupScene, popupCamera);
            }
            controls.update(); renderer.render( scene, camera );
        }
        animate();
        window.addEventListener( 'resize', () => { 
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); 
            renderer.setSize( window.innerWidth, window.innerHeight ); 
            if(document.getElementById('modal-overlay').style.display === 'flex') {
                const container = document.getElementById('modal-3d');
                popupCamera.aspect = container.clientWidth / container.clientHeight;
                popupCamera.updateProjectionMatrix();
                popupRenderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>
